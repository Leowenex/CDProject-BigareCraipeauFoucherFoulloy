
def apiImage = ''
pipeline {

  agent {
    label 'jenkins-slave'
  }

  stages {
    stage('Cloning Git') {
      steps {
        git branch: 'main', credentialsId: 'Git', url: 'https://github.com/Leowenex/CDProject-BigareCraipeauFoucherFoulloy'
      }
    }
    stage('Building api image') {
      steps {
        script {
          dir('webapi') {
            apiImage = docker.build("leowenex/api-bcff:2025")

          }
        }
      }
    }
    stage('Publish api Image') {
      steps {
        script {
          withDockerRegistry(credentialsId: 'DockerHubLeowenex') {
            apiImage.push()
          }

        }
      }
    }

    stage('Deploy api container to Dev environment') {
      steps {
        withKubeConfig(caCertificate: '', clusterName: 'minikube', contextName: 'minikube', credentialsId: 'minikube-jenkins-secret', namespace: 'dev', restrictKubeConfigAccess: false, serverUrl: 'https://host.docker.internal:51941') {
          sh "kubectl create deployment api-bcff --image=leowenex/api-bcff:2025"
          sh "kubectl expose deployment api-bcff --type=NodePort --port=8080"
        }
      }
    }

    // Curl the service at /whoami to see if it's running and check the response is 200 and contains "BCFF"
    stage('Test api running on Dev environment') {
      steps {
        script {
          def response = sh(script: "curl -s -o /dev/null -w \"%{http_code}\" http://dev.bcff.io/whoami", returnStdout: true).trim()
          if (response != '200') {
            error "Failed to curl the service"
          }
          response = sh(script: "curl -s http://dev.bcff.io/whoami", returnStdout: true).trim()
          if (!response.contains("BCFF")) {
            error "Response does not contain BCFF"
          }
        }
      }
    }

    stage('Deploy api container to Prod environment') {
      steps {
        withKubeConfig(caCertificate: '', clusterName: 'minikube', contextName: 'minikube', credentialsId: 'minikube-jenkins-secret', namespace: 'prod', restrictKubeConfigAccess: false, serverUrl: 'https://host.docker.internal:51941') {
          sh "kubectl create deployment api-bcff --image=leowenex/api-bcff:2025"
          sh "kubectl expose deployment api-bcff --type=NodePort --port=8080"
        }
      }
    }
  }
}
